<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Merch | PYB Fitness</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
</head>
<body style="background-color:black; color:deepskyblue; font-family:sans-serif; text-align:center;">
  <h2>Admin Merch</h2>
  <h4>Add New Item</h4>

  <input id="name" placeholder="Item Name" style="width:95%; margin-bottom:10px;" />
  <input type="file" id="imageInput" accept="image/*" style="width:95%;" />
  <br /><img id="imagePreview" src="https://via.placeholder.com/300x150?text=Image+preview" style="max-width:300px; height:auto; margin:10px;" />
  <br />
  <textarea id="description" placeholder="Description" style="width:95%; margin-top:10px;"></textarea><br />
  <input id="price" type="number" placeholder="Price (£)" style="width:95%;" /><br />
  <input id="stock" type="number" placeholder="Stock Quantity" style="width:95%;" /><br />
  <button onclick="addItem()" style="margin-top:10px;">Add Item</button>

  <h4 style="margin-top:30px;">Current Inventory</h4>
  <div id="inventory" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; padding:10px;"></div>

  <nav style="position:fixed; bottom:0; left:0; right:0; background:black; display:flex; justify-content:space-around; padding:10px 0;">
    <a href="dashboard.html" style="color:white;">Dashboard</a>
    <a href="admin-timetable.html" style="color:white;">Timetable</a>
    <a href="admin-programming.html" style="color:white;">Programming</a>
    <a href="admin-training.html" style="color:white;">Training</a>
    <a href="admin-merch.html" style="color:deepskyblue;">Merch</a>
    <a href="more.html" style="color:white;">More</a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBgu6zMvtOqz9admi-Ai9QmH79I2f7Lq8I",
      authDomain: "pyb-fitness-web-app.firebaseapp.com",
      projectId: "pyb-fitness-web-app",
      storageBucket: "pyb-fitness-web-app.appspot.com",
      messagingSenderId: "64609252136",
      appId: "1:64609252136:web:4045e9aab5f5bd11f2161d",
      measurementId: "G-SDDD8W759S"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const inventoryRef = collection(db, "merch");

    const inventoryDiv = document.getElementById("inventory");
    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");

    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (file) {
        imagePreview.src = URL.createObjectURL(file);
      } else {
        imagePreview.src = "https://via.placeholder.com/300x150?text=Image+preview";
      }
    });

    async function fetchInventory() {
      inventoryDiv.innerHTML = "";
      const snapshot = await getDocs(inventoryRef);
      snapshot.forEach(docSnap => {
        const item = docSnap.data();
        const div = document.createElement("div");
        div.style.backgroundColor = "#111";
        div.style.color = "white";
        div.style.padding = "10px";
        div.style.borderRadius = "8px";
        div.style.minHeight = "300px";
        div.innerHTML = `
          <img src="${item.imageUrl || 'https://via.placeholder.com/300x150?text=No+Image'}" style="width:100%; height:auto; object-fit:cover; border-radius:4px;"/>
          <h4 style="color:deepskyblue;">${item.name}</h4>
          <p><strong>Description:</strong> ${item.description}</p>
          <p><strong>Price:</strong> £${item.price}</p>
          <p><strong>Stock:</strong> ${item.stock}</p>
          <button onclick="editItem('${docSnap.id}', '${item.name}', '${item.description}', ${item.price}, ${item.stock})">Edit</button>
          <button onclick="deleteItem('${docSnap.id}')">Delete</button>
        `;
        inventoryDiv.appendChild(div);
      });
    }

    async function addItem() {
      const name = document.getElementById("name").value;
      const description = document.getElementById("description").value;
      const price = parseFloat(document.getElementById("price").value);
      const stock = parseInt(document.getElementById("stock").value);
      const file = imageInput.files[0];

      let imageUrl = "";

      if (file) {
        const storageRef = ref(storage, 'merch/' + file.name);
        const snapshot = await uploadBytes(storageRef, file);
        imageUrl = await getDownloadURL(snapshot.ref);
      }

      await addDoc(inventoryRef, {
        name, description, price, stock, imageUrl
      });

      document.getElementById("name").value = "";
      document.getElementById("description").value = "";
      document.getElementById("price").value = "";
      document.getElementById("stock").value = "";
      imageInput.value = "";
      imagePreview.src = "https://via.placeholder.com/300x150?text=Image+preview";

      fetchInventory();
    }

    async function deleteItem(id) {
      await deleteDoc(doc(db, "merch", id));
      fetchInventory();
    }

    function editItem(id, name, description, price, stock) {
      document.getElementById("name").value = name;
      document.getElementById("description").value = description;
      document.getElementById("price").value = price;
      document.getElementById("stock").value = stock;
      imageInput.value = "";
      imagePreview.src = "https://via.placeholder.com/300x150?text=Image+preview";

      const addButton = document.querySelector("button[onclick='addItem()']");
      addButton.innerText = "Update Item";
      addButton.onclick = async () => {
        await updateDoc(doc(db, "merch", id), {
          name: document.getElementById("name").value,
          description: document.getElementById("description").value,
          price: parseFloat(document.getElementById("price").value),
          stock: parseInt(document.getElementById("stock").value),
        });
        addButton.innerText = "Add Item";
        addButton.onclick = addItem;
        fetchInventory();
      };
    }

    fetchInventory();
  </script>
</body>
</html>
